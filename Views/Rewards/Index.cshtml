@model BIP_SMEMC.Models.ViewModels.RewardsPageViewModel
@{
    ViewData["Title"] = "Rewards & Game Points";
    var activeTab = string.IsNullOrWhiteSpace(Model.ActiveTab) ? "vouchers" : Model.ActiveTab;
    if (activeTab == "earn")
    {
        activeTab = "vouchers";
    }

    string GetProgressTrack(BIP_SMEMC.Models.CommunityBadge badge)
    {
        var text = $"{badge.Title} {badge.Description}".ToLowerInvariant();
        if (text.Contains("module")) return "learning-modules";
        if (text.Contains("quiz")) return "learning-quiz";
        if (text.Contains("thread") || text.Contains("discussion")) return "community-discussions";
        if (text.Contains("reply")) return "community-replies";
        if (text.Contains("event") || text.Contains("rsvp")) return "community-events";
        if (text.Contains("resource") || text.Contains("download")) return "community-resources";
        if (text.Contains("point") || text.Contains("reputation")) return "points";
        return "general";
    }

    var earnedAchievements = Model.Achievements
        .Where(a => string.Equals(a.Status, "earned", StringComparison.OrdinalIgnoreCase))
        .ToList();

    var firstPendingPerTrack = Model.Achievements
        .Where(a => !string.Equals(a.Status, "earned", StringComparison.OrdinalIgnoreCase))
        .OrderBy(a => a.ProgressTarget ?? int.MaxValue)
        .ThenBy(a => a.ProgressCurrent ?? 0)
        .ThenBy(a => a.Points)
        .ThenBy(a => a.Id)
        .GroupBy(GetProgressTrack)
        .Select(g => g.First())
        .ToList();

    var hasEarnedAchievements = earnedAchievements.Count > 0;
}

<div class="container-fluid py-4">
    <div class="mb-3">
        <h2 class="fw-bold mb-1">Rewards & Game Points</h2>
        <div class="text-muted">Earn points and claim exclusive vouchers</div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="row g-3 mb-3">
        <div class="col-md-6 col-xl-3">
            <div class="card h-100 border-warning-subtle bg-warning-subtle">
                <div class="card-body">
                    <div class="small fw-semibold mb-2"><i class="bi bi-trophy me-1"></i>Total Points</div>
                    <div class="display-6 fw-bold">@Model.CurrentPoints</div>
                    <div class="text-muted">Available to spend</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="small fw-semibold mb-2"><i class="bi bi-graph-up-arrow me-1 text-success"></i>Total Earned</div>
                    <div class="display-6 fw-bold">@Model.TotalEarned</div>
                    <div class="text-muted">All time</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="small fw-semibold mb-2"><i class="bi bi-gift me-1 text-primary"></i>Total Redeemed</div>
                    <div class="display-6 fw-bold">@Model.TotalRedeemed</div>
                    <div class="text-muted">Points spent</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="small fw-semibold mb-2"><i class="bi bi-award me-1 text-purple"></i>Achievements</div>
                    <div class="display-6 fw-bold">@Model.AchievementsUnlocked/@Model.TotalAchievements</div>
                    <div class="text-muted">Unlocked</div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills bg-body-tertiary rounded-pill p-1 mb-4" id="rewards-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill @(activeTab == "vouchers" ? "active" : "")"
                    id="vouchers-tab"
                    data-bs-toggle="pill"
                    data-bs-target="#vouchers-panel"
                    type="button"
                    role="tab">
                Available Vouchers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill @(activeTab == "achievements" ? "active" : "")"
                    id="achievements-tab"
                    data-bs-toggle="pill"
                    data-bs-target="#achievements-panel"
                    type="button"
                    role="tab">
                Achievements
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill @(activeTab == "history" ? "active" : "")"
                    id="history-tab"
                    data-bs-toggle="pill"
                    data-bs-target="#history-panel"
                    type="button"
                    role="tab">
                Transaction History
            </button>
        </li>
    </ul>

    <div class="tab-content" id="rewards-tab-content">
        <div class="tab-pane fade @(activeTab == "vouchers" ? "show active" : "")" id="vouchers-panel" role="tabpanel">
            <div class="row g-3" id="vouchersList">
                @foreach (var reward in Model.Rewards)
                {
                    <div class="col-md-6 col-xl-4 paginate-item">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-secondary-subtle text-dark">@reward.Category</span>
                                    <span class="small text-muted">@reward.PointsCost pts</span>
                                </div>
                                <h5 class="fw-bold">@reward.Title</h5>
                                <div class="text-muted small mb-2">@reward.Partner</div>
                                <p class="text-muted flex-grow-1">@reward.Description</p>

                                <form method="post" action="@Url.Action("Redeem", "Rewards")">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="rewardId" value="@reward.Id" />
                                    <button class="btn btn-dark w-100" type="submit" @(Model.CurrentPoints < reward.PointsCost ? "disabled" : "")>
                                        <i class="bi bi-gift me-1"></i>Claim Now
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div id="vouchersPager" class="d-flex gap-2 justify-content-center mt-3"></div>
        </div>

        <div class="tab-pane fade @(activeTab == "achievements" ? "show active" : "")" id="achievements-panel" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="fw-bold mb-1">Your Achievements</h5>
                    <div class="text-muted mb-3">Unlock achievements to earn bonus points</div>
                    @if (Model.Achievements.Count == 0)
                    {
                        <div class="text-muted">No achievements found in database.</div>
                    }
                    else
                    {
                        @if (firstPendingPerTrack.Count == 0)
                        {
                            <div class="text-muted mb-2">All current milestone tracks are completed.</div>
                        }
                        else
                        {
                            <div id="achievementsList">
                            @foreach (var badge in firstPendingPerTrack)
                            {
                                var progressPercent = Math.Max(0, Math.Min(100, badge.ProgressPercent ?? 0));

                                <div class="rounded-3 border p-3 mb-3 paginate-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="rounded-3 bg-body-tertiary p-2">
                                                <i class="bi @badge.Icon @badge.IconColor fs-5"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">@badge.Title</div>
                                                <div class="text-muted">@badge.Description</div>
                                            </div>
                                        </div>
                                        <span class="badge rounded-pill bg-body-tertiary text-body border">
                                            <i class="bi bi-trophy me-1"></i>@badge.Points pts
                                        </span>
                                    </div>

                                    @if (badge.ProgressTarget.HasValue && badge.ProgressTarget.Value > 0)
                                    {
                                        <div class="small text-muted mb-1">Progress</div>
                                        <div class="progress" style="height:8px;">
                                            <div class="progress-bar bg-dark" role="progressbar" style="width:@progressPercent%"></div>
                                        </div>
                                        <div class="text-end small mt-1">@((badge.ProgressCurrent ?? 0)) / @badge.ProgressTarget</div>
                                    }
                                </div>
                            }
                            </div>
                            <div id="achievementsPager" class="d-flex gap-2 justify-content-center mt-3"></div>
                        }

                        @if (hasEarnedAchievements)
                        {
                            <div class="mt-3">
                                <button class="btn btn-outline-secondary btn-sm"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#completedAchievementsCollapse"
                                        aria-expanded="false"
                                        aria-controls="completedAchievementsCollapse">
                                    Show Completed Achievements (@earnedAchievements.Count)
                                </button>
                            </div>

                            <div class="collapse mt-3" id="completedAchievementsCollapse">
                                @foreach (var badge in earnedAchievements)
                                {
                                    <div class="rounded-3 border border-success-subtle bg-success-subtle p-3 mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="rounded-3 bg-body-tertiary p-2">
                                                    <i class="bi @badge.Icon @badge.IconColor fs-5"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">@badge.Title</div>
                                                    <div class="text-muted">@badge.Description</div>
                                                </div>
                                            </div>
                                            <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle">
                                                Unlocked
                                            </span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="tab-pane fade @(activeTab == "history" ? "show active" : "")" id="history-panel" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Points Transaction History</h5>
                    @if (Model.History.Count == 0)
                    {
                        <div class="text-muted">No transactions yet.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Activity</th>
                                        <th class="text-end">Points</th>
                                    </tr>
                                </thead>
                                <tbody id="historyList">
                                @foreach (var item in Model.History)
                                {
                                    <tr class="paginate-item">
                                        <td>@item.Date.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>@item.Activity</td>
                                        <td class="text-end fw-semibold @(item.Points >= 0 ? "text-success" : "text-danger")">
                                            @(item.Points >= 0 ? "+" : "")@item.Points
                                        </td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                        <div id="historyPager" class="d-flex gap-2 justify-content-center mt-3"></div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            function paginate(containerSelector, itemSelector, pagerSelector, pageSize) {
                const container = document.querySelector(containerSelector);
                const pager = document.querySelector(pagerSelector);
                if (!container || !pager) return;

                const items = Array.from(container.querySelectorAll(itemSelector));
                if (items.length === 0) {
                    pager.innerHTML = "";
                    return;
                }

                const pages = Math.ceil(items.length / pageSize);
                let current = 1;

                const render = () => {
                    items.forEach((el, i) => {
                        const show = i >= (current - 1) * pageSize && i < current * pageSize;
                        el.style.display = show ? "" : "none";
                    });

                    if (pages <= 1) {
                        pager.innerHTML = "";
                        return;
                    }

                    pager.innerHTML = "";
                    for (let p = 1; p <= pages; p++) {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = `btn btn-sm ${p === current ? "btn-dark" : "btn-outline-secondary"}`;
                        btn.textContent = p;
                        btn.addEventListener("click", () => {
                            current = p;
                            render();
                        });
                        pager.appendChild(btn);
                    }
                };

                render();
            }

            paginate("#vouchersList", ".paginate-item", "#vouchersPager", 6);
            paginate("#achievementsList", ".paginate-item", "#achievementsPager", 6);
            paginate("#historyList", ".paginate-item", "#historyPager", 10);

            const tabs = document.querySelectorAll('#rewards-tabs button[data-bs-toggle="pill"]');
            tabs.forEach(function (tab) {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const tabId = event.target.id.replace('-tab', '');
                    const url = new URL(window.location.href);
                    url.searchParams.set('tab', tabId);
                    window.history.replaceState({}, '', url);
                });
            });
        })();
    </script>
}
