@model BIP_SMEMC.Models.BudgetViewModel

<div class="container-fluid p-4">
    <div class="row g-3 mb-4" id="topSummaryCards">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-danger text-white">
                <div class="card-body">
                    <h6 class="small text-uppercase opacity-75 fw-bold">Budget Alerts</h6>
                    <div id="overspentDetails" class="small">Calculating...</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="small text-uppercase opacity-75 fw-bold mb-0">Reallocation</h6>
                        <button id="btnSmartReallocate" class="btn btn-xs btn-light text-success fw-bold d-none" onclick="smartReallocate()">
                            <i class="bi bi-magic"></i> Auto-Fix
                        </button>
                    </div>
                    <div id="savingsDetails" class="small">Calculating...</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-white">
                <div class="card-body">
                    <h6 class="small text-uppercase text-muted fw-bold">Total Variance</h6>
                    <h4 id="netVariance" class="fw-bold mb-0">$0.00</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 fw-bold">Budget Analysis</h1>
        <div class="btn-group shadow-sm">
            <button class="btn btn-sm btn-white border" onclick="updateRange(3)">3M</button>
            <button class="btn btn-sm btn-white border" onclick="updateRange(6)">6M</button>
            <button class="btn btn-sm btn-white border" onclick="updateRange(12)">1Y</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 id="chartHeader" class="fw-bold m-0">Consolidated Monthly Spending vs Budget</h6>
                <button id="resetChartBtn" class="btn btn-xs btn-outline-primary d-none" onclick="renderTrendChart()">
                    <i class="bi bi-arrow-left"></i> Back to Trend
                </button>
            </div>
            <div id="mainChartContainer" style="height: 350px;">
                <canvas id="mainBudgetChart"></canvas>
            </div>
            <div id="breakdownContainer" class="d-none" style="height: 350px;">
                <canvas id="breakdownChart"></canvas>
            </div>
        </div>
    </div>

    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold m-0"><i class="bi bi-shield-check me-2"></i>Budget Health & Variance Monitor</h6>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editBudgetModal">
                <i class="bi bi-plus-circle me-1"></i> Adjust Budget
            </button>
        </div>

        <div class="row g-3" id="budgetHealthCards">
        </div>
    </div>

    <div class="accordion border-0 shadow-sm" id="ledgerAccordion">
        <div class="accordion-item border-0">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-bold bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLedger">
                    <i class="bi bi-journal-text me-2"></i> <span id="tableTitle">Detailed Transaction Audit</span>
                </button>
            </h2>
            <div id="collapseLedger" class="accordion-collapse collapse" data-bs-parent="#ledgerAccordion">
                <div class="table-responsive bg-white">
                    <table class="table table-hover align-middle small mb-0">
                        <thead class="table-light">
                            <tr><th>Date</th><th>Description</th><th>Group</th><th class="text-end">Amount</th></tr>
                        </thead>
                        <tbody id="budgetLedgerBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editBudgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="fw-bold">Update Category Budget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="small text-muted mb-1">Select Category</label>
                <select id="modalCatId" class="form-select mb-3">
                    @foreach (var cat in Model.ExpenseCategories) // Change from ActiveCategories to all Tier 1
                    {
                        <option value="@cat.Id">@cat.Name</option>
                    }
                </select>
                <label class="small text-muted mb-1">Budget Amount ($)</label>
                <input type="number" id="modalAmount" class="form-control mb-3" placeholder="e.g. 5000">
                <div class="row">
                    <div class="col-6">
                        <label class="small text-muted">Month</label>
                        <select id="modalMonth" class="form-select">
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i" selected="@(i == 1)">@i</option>
                            }
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">Year</label>
                        <input type="number" id="modalYear" class="form-control" value="2024">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100" onclick="saveBudgetChange()">Save and Apply Carry-Forward</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const transactions = @Html.Raw(Json.Serialize(Model.AllTransactions));
        const categories = @Html.Raw(Json.Serialize(Model.ActiveCategories)); // Fixed: Only show active
        const budgetHistory = @Html.Raw(Json.Serialize(Model.BudgetRecords));
        let currentMonthObj = null;
        let mainChart, breakdownChart;
        let activeRange = 6;
        let chartInstance;
        const latestDateStr = "@Model.LatestDataDate.ToString("yyyy-MM-dd")";
        const latestDate = new Date(latestDateStr);

        // --- CORE LOGIC: GET EFFECTIVE BUDGET (CARRY FORWARD) ---
        function getEffectiveBudget(catId, month, year) {
            const match = budgetHistory.find(b => b.categoryId === catId && b.month === month && b.year === year);
            return match ? match.budgetAmount : 1000; // Default $1000
        }

        function renderTrendChart() {
            const months = getMonthRange(); // This now generates Aug 23 - Jan 24 for 6M
            const ctx = document.getElementById('mainBudgetChart').getContext('2d');
            document.getElementById('resetChartBtn').classList.add('d-none');

            const datasets = categories.map((cat, i) => ({
                label: cat.name,
                data: months.map(m => transactions.filter(t => t.parentCategoryName === cat.name && (new Date(t.date).getMonth()+1) === m.month && new Date(t.date).getFullYear() === m.year).reduce((sum, t) => sum + t.debit, 0)),
                backgroundColor: `hsl(${(i * 60) % 360}, 65%, 55%)`
            }));

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: months.map(m => m.label), datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    onClick: (e, elements) => {
                        if(elements.length > 0) renderMonthlyHealth(months[elements[0].index]);
                    }
                }
            });
            renderHealthCards(months[months.length - 1]); // Show current month health
            updateTable(transactions);
        }

        function renderHealthCards(mObj) {
            const container = document.getElementById('budgetHealthCards');
            container.innerHTML = '';

            categories.forEach(cat => {
                const actual = transactions.filter(t =>
                    t.parentCategoryName === cat.name &&
                    (new Date(t.date).getMonth()+1) === mObj.month
                ).reduce((sum, t) => sum + t.debit, 0);

                let budget = getEffectiveBudget(cat.id, mObj.month, mObj.year) || 1000;
                const pct = (actual / budget) * 100;

                // Reactive Color Logic
                let barColor = 'bg-success'; // Green
                if (pct > 100) barColor = 'bg-danger'; // Red (Over)
                else if (pct >= 85) barColor = 'bg-warning'; // Yellow (Hit/Near)

                container.innerHTML += `
                    <div class="col-md-4 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold small">${cat.name}</span>
                                    <button class="btn btn-xs ${pct >= 100 ? 'btn-danger' : 'btn-outline-primary'}"
                                            onclick="openBudgetModal(${cat.id}, ${actual})">
                                        <i class="bi ${pct >= 100 ? 'bi-exclamation-triangle-fill' : 'bi-pencil'}"></i>
                                    </button>
                                </div>
                                <div class="progress" style="height: 12px;">
                                    <div class="progress-bar ${barColor}" style="width: ${Math.min(pct, 100)}%"></div>
                                </div>
                                <div class="d-flex justify-content-between extra-small mt-1">
                                    <span>$${actual.toLocaleString()} spent</span>
                                    <span class="text-muted">Limit: $${budget.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }
        // SMART REALLOCATE IMPROVEMENT: Handle large numbers
        async function smartReallocate() {
            const { over, save } = window.reallocData;

            // UI Feedback for large batches
            const btn = document.getElementById('btnSmartReallocate');
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;
            btn.disabled = true;

            // Use Promise.all for faster batch updates if your category list is long
            const updates = over.map(cat => {
                const formData = new URLSearchParams({
                    categoryId: cat.id,
                    amount: cat.actual,
                    month: currentMonthObj.month,
                    year: currentMonthObj.year
                });
                return fetch('/Budget/UpdateBudget', { method: 'POST', body: formData });
            });

            await Promise.all(updates);
            location.reload();
        }        function openBudgetModal(catId, suggestedAmount) {
            document.getElementById('modalCatId').value = catId;
            document.getElementById('modalAmount').value = Math.ceil(suggestedAmount); // Round up to cover expenses

            const myModal = new bootstrap.Modal(document.getElementById('editBudgetModal'));
            myModal.show();

            console.log(`[DEBUG] Readjustment triggered for Category ${catId}. Suggested min: ${suggestedAmount}`);
        }
        function drillToCategory(catName, month) {
            const target = new bootstrap.Collapse(document.getElementById('collapseLedger'), { toggle: false });
            target.show();
            const filtered = transactions.filter(t => t.parentCategoryName === catName && (new Date(t.date).getMonth()+1) === month);
            document.getElementById('tableTitle').innerText = `${catName} Transactions (Month ${month})`;
            updateTable(filtered);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function saveBudgetChange() {
            const data = {
                categoryId: document.getElementById('modalCatId').value,
                amount: document.getElementById('modalAmount').value,
                month: document.getElementById('modalMonth').value,
                year: document.getElementById('modalYear').value
            };

            console.log("[AJAX] Sending Budget Update:", data);

            try {
                const res = await fetch('/Budget/UpdateBudget', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams(data)
                });

                const result = await res.json();

                if (result.success) {
                    console.log("[AJAX SUCCESS] Budget updated in DB.");
                    bootstrap.Modal.getInstance(document.getElementById('editBudgetModal')).hide();
                    location.reload();
                } else {
                    console.error("[AJAX ERROR]", result.error);
                    alert("Database Error: " + result.error);
                }
            } catch (err) {
                console.error("[NETWORK ERROR]", err);
                alert("Network failure. Check console.");
            }
        }
        // 1. MAIN TREND CHART (Stacked)
        function renderTrendChart() {
            const months = getMonthRange();
            const ctx = document.getElementById('mainBudgetChart').getContext('2d');

            // Hide breakdown if open
            if(breakdownChart) { breakdownChart.destroy(); }
            document.getElementById('breakdownContainer').classList.add('d-none');
            document.getElementById('mainChartContainer').classList.remove('d-none');

            const datasets = categories.map((cat, i) => ({
                label: cat.name,
                data: months.map(m => transactions
                    .filter(t => t.parentCategoryName === cat.name && new Date(t.date).getMonth()+1 === m.month)
                    .reduce((s, t) => s + t.debit, 0)),
                backgroundColor: `hsl(${(i * 50) % 360}, 70%, 60%)`
            }));

            if(mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: months.map(m => m.label), datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } },
                            onClick: (e, elements) => {
                                if(elements.length > 0) {
                                    const idx = elements[0].index;
                                    const selectedMonthObj = months[idx]; // { month: 12, year: 2023, label: 'Dec 23' }

                                    // Render Drilldown Chart
                                    renderMonthlyBreakdown(selectedMonthObj);

                                    // NEW: Filter Table for this month
                                    const monthlyTransactions = transactions.filter(t => {
                                        const d = new Date(t.date);
                                        return (d.getMonth() + 1) === selectedMonthObj.month && d.getFullYear() === selectedMonthObj.year;
                                    });

                                    // Update Title and Body
                                    document.getElementById('tableTitle').innerText = `Transactions for ${selectedMonthObj.label}`;
                                    updateTable(monthlyTransactions);
                                }
                            }
                }
            });

            // Render cards for latest month
            renderHealthCards(months[months.length-1]);
        }

        // 2. DRILL-DOWN CHART (Side-by-Side: Budget vs Actual)
        function renderMonthlyBreakdown(mObj) {
            // Show Breakdown Canvas
            document.getElementById('mainChartContainer').classList.add('d-none');
            document.getElementById('breakdownContainer').classList.remove('d-none');
            document.getElementById('chartHeader').innerText = `Breakdown: ${mObj.label}`;
            document.getElementById('resetChartBtn').classList.remove('d-none');

            const ctx = document.getElementById('breakdownChart').getContext('2d');

            const actuals = categories.map(c => transactions
                .filter(t => t.parentCategoryName === c.name && new Date(t.date).getMonth()+1 === mObj.month)
                .reduce((s,t) => s + t.debit, 0));

            const budgets = categories.map(c => getEffectiveBudget(c.id, mObj.month, mObj.year));

            if(breakdownChart) breakdownChart.destroy();
            breakdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [
                        { label: 'Actual Spent', data: actuals, backgroundColor: '#ef4444' },
                        { label: 'Budget Limit', data: budgets, backgroundColor: '#10b981' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { title: { display: true, text: `Budget vs Actual (${mObj.label})` } }
                }
            });

            // Sync Cards to this month
            renderHealthCards(mObj);
        }

        function getMonthRange() {
            const labels = [];
            for (let i = activeRange - 1; i >= 0; i--) {
                const d = new Date(latestDate.getFullYear(), latestDate.getMonth() - i, 1);
                labels.push({
                    month: d.getMonth() + 1,
                    year: d.getFullYear(),
                    label: d.toLocaleString('default', { month: 'short', year: '2-digit' })
                });
            }
            return labels;
        }
        function updateRange(r) { activeRange = r; renderTrendChart(); }
                
        // 1. UPDATE TABLE FUNCTION
        function updateTable(data) {
            const tbody = document.getElementById('budgetLedgerBody');
            const tableTitle = document.getElementById('tableTitle');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No transactions for this period.</td></tr>';
                return;
            }

            // Sort by date descending
            data.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = data.slice(0, 50).map(t => `
                <tr>
                    <td>${new Date(t.date).toLocaleDateString()}</td>
                    <td class="text-truncate" style="max-width: 300px;" title="${t.description}">${t.description}</td>
                    <td><span class="badge bg-light text-dark border">${t.parentCategoryName}</span></td>
                    <td class="text-end fw-bold text-danger">$${t.debit.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        document.addEventListener("DOMContentLoaded", renderTrendChart);
    </script>
}