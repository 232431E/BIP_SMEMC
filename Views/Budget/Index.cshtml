@model BIP_SMEMC.Models.BudgetViewModel

<div class="container-fluid p-4 bg-light min-vh-100">
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-danger text-white h-100">
                <div class="card-body">
                    <h6 class="small text-uppercase opacity-75 fw-bold">Budget Alerts</h6>
                    <div id="overspentDetails" class="h5 mb-0">Calculating...</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-success text-white h-100">
                <div class="card-body">
                    <h6 class="small text-uppercase opacity-75 fw-bold mb-0">Within Budget</h6>
                    <div id="savingsDetails" class="h5 mb-0">Calculating...</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-white h-100">
                <div class="card-body">
                    <h6 class="small text-uppercase text-muted fw-bold">Quick Actions</h6>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="autoReallocate()">
                            <i class="bi bi-shuffle"></i> Reallocate
                        </button>
                        <button class="btn btn-sm btn-outline-success flex-grow-1" onclick="smartIncrease()">
                            <i class="bi bi-arrow-up-circle"></i> Fix All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark mb-1">Budget Analysis</h1>
            <p class="text-muted small mb-0">Spending vs Allocated Limits</p>
        </div>
        <div class="btn-group shadow-sm">
            <button class="btn btn-sm btn-white border" onclick="updateRange(3)">3M</button>
            <button class="btn btn-sm btn-white border" onclick="updateRange(6)">6M</button>
            <button class="btn btn-sm btn-white border" onclick="updateRange(12)">1Y</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 id="chartHeader" class="fw-bold m-0">Spending Trend</h6>
            <button id="resetChartBtn" class="btn btn-sm btn-outline-primary d-none" onclick="backToTrend()">Back to Trend</button>
        </div>
        <div class="card-body">
            <div id="mainChartContainer" style="height: 350px;"><canvas id="mainBudgetChart"></canvas></div>
            <div id="breakdownChartContainer" class="d-none" style="height: 350px;"><canvas id="breakdownChart"></canvas></div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0">Performance: <span id="selectedMonthLabel">...</span></h6>
                    <button class="btn btn-sm btn-primary" onclick="openBudgetModal(null, 0, true)">+ Set Budget</button>
                </div>
                <div class="px-3 py-2 bg-light border-bottom d-flex justify-content-between align-items-center font-monospace">
                    <span class="small fw-bold text-muted">MONTHLY LIMIT:</span>
                    <span id="monthTotalBudgetLabel" class="fw-bold text-primary">$0.00</span>
                </div>
                <div class="card-body p-0 d-flex flex-column" style="height: 550px;">
                    <div id="healthListContainer" class="flex-grow-1" style="overflow-y: auto;"></div>

                    <div class="accordion accordion-flush border-top" id="unusedAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2 small text-muted bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#unusedCollapse">
                                    Unused Categories (<span id="unusedCount">0</span>)
                                </button>
                            </h2>
                            <div id="unusedCollapse" class="accordion-collapse collapse" data-bs-parent="#unusedAccordion">
                                <div class="accordion-body p-0" id="unusedListContainer" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0" id="tableTitle">Transactions</h6>
                    <div class="d-flex gap-2">
                        <select id="pageSizeSelect" class="form-select form-select-sm" style="width: 80px;" onchange="changePageSize()">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                        </select>
                        <button class="btn btn-xs btn-outline-secondary" onclick="clearTableFilters()">Show All</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm small mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="cursor-pointer" onclick="sortTable('Date')">Date <i class="bi bi-arrow-down-up"></i></th>
                                <th>Description</th>
                                <th>Category</th>
                                <th class="text-end cursor-pointer" onclick="sortTable('Amount')">Amount <i class="bi bi-arrow-down-up"></i></th>
                            </tr>
                        </thead>
                        <tbody id="budgetLedgerBody"></tbody>
                    </table>
                </div>
                <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center py-2">
                    <span id="pageInfoLabel" class="extra-small text-muted"></span>
                    <div class="btn-group">
                        <button class="btn btn-xs btn-outline-primary" onclick="changePage(-1)">Prev</button>
                        <button class="btn btn-xs btn-outline-primary" onclick="changePage(1)">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editBudgetModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h6 class="fw-bold" id="modalTitle">Set Budget</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalSearchContainer">
                    <label class="small text-muted">Search Category</label>
                    <input type="text" id="modalSearch" class="form-control form-control-sm mb-2" placeholder="Type to search..." onkeyup="filterModalSelect()">
                </div>
                <label class="small text-muted">Category</label>
                <select id="modalCatId" class="form-select form-select-sm mb-3" size="5">
                    @foreach (var cat in Model.ExpenseCategoriesDTO.OrderBy(x => x.Name))
                    {
                        <option value="@cat.Id">@cat.Name</option>
                    }
                </select>
                <label class="small text-muted">Monthly Limit ($)</label>
                <input type="number" id="modalAmount" class="form-control form-control-sm mb-3" placeholder="0.00">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="small text-muted">Month</label>
                        <select id="modalMonth" class="form-select form-select-sm">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">Year</label>
                        <input type="number" id="modalYear" class="form-control form-control-sm">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-sm btn-primary w-100" onclick="saveBudgetChange()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const transactions = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.AllTransactionsDTO));
        const categories = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ExpenseCategoriesDTO));
        const budgetHistory = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.BudgetsDTO));
        const latestDate = new Date("@Model.LatestDataDate.ToString("yyyy-MM-dd")");

        let state = {
            activeRange: 3,
            currentMonthObj: null,
            selectedCategory: null,
            tableData: [],
            pageSize: 15,
            currentPage: 1,
            sortCol: 'Date',
            sortDir: -1,
            isBreakdown: false
        };

        const pastelColors = ['#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF'];
        let mainChart, breakdownChart;

        document.addEventListener("DOMContentLoaded", () => updateRange(3));

        // Logic: Search backward for most recent budget record
        function getEffectiveBudget(catId, month, year) {
            const history = budgetHistory.filter(b => b.CategoryId === catId);
            const sorted = history.sort((a, b) => b.Year !== a.Year ? b.Year - a.Year : b.Month - a.Month);
            const match = sorted.find(b => (b.Year < year) || (b.Year === year && b.Month <= month));
            return match ? match.BudgetAmount : 0;
        }

        function renderTrendChart() {
            state.isBreakdown = false;
            document.getElementById('mainChartContainer').classList.remove('d-none');
            document.getElementById('breakdownChartContainer').classList.add('d-none');
            document.getElementById('resetChartBtn').classList.add('d-none');
            document.getElementById('chartHeader').innerText = "Spending Trend vs Budget";

            const months = getMonthRange();
            const budgetLineData = months.map(m => categories.reduce((sum, cat) => sum + getEffectiveBudget(cat.Id, m.month, m.year), 0));

            const datasets = categories.map((cat, i) => {
                const dataPoints = months.map(m => transactions.filter(t => t.CategoryName === cat.Name && new Date(t.Date).getMonth()+1 === m.month && new Date(t.Date).getFullYear() === m.year).reduce((s,t) => s + t.Amount, 0));
                return dataPoints.some(v => v > 0) ? { type: 'bar', label: cat.Name, data: dataPoints, backgroundColor: pastelColors[i % pastelColors.length], stack: 'A' } : null;
            }).filter(d => d !== null);

            if(mainChart) mainChart.destroy();
            mainChart = new Chart(document.getElementById('mainBudgetChart'), {
                data: { labels: months.map(m => m.label), datasets: [{ type: 'line', label: 'Total Limit', data: budgetLineData, borderColor: '#333', fill: false, pointRadius: 2 }, ...datasets] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    onClick: (e, el) => { if(el.length) { state.isBreakdown = true; enterMonthView(months[el[0].index]); } }
                }
            });
            enterMonthView(months[months.length-1]);
        }

        function renderBreakdownChart(mObj) {
            document.getElementById('mainChartContainer').classList.add('d-none');
            document.getElementById('breakdownChartContainer').classList.remove('d-none');
            document.getElementById('resetChartBtn').classList.remove('d-none');
            document.getElementById('chartHeader').innerText = `Breakdown: ${mObj.label}`;

            const activeCats = categories.map(c => ({
                name: c.Name,
                actual: transactions.filter(t => t.CategoryName === c.Name && new Date(t.Date).getMonth()+1 === mObj.month && new Date(t.Date).getFullYear() === mObj.year).reduce((s,t) => s + t.Amount, 0),
                budget: getEffectiveBudget(c.Id, mObj.month, mObj.year)
            })).filter(x => x.actual > 0 || x.budget > 0);

            if(breakdownChart) breakdownChart.destroy();
            breakdownChart = new Chart(document.getElementById('breakdownChart'), {
                type: 'bar',
                data: {
                    labels: activeCats.map(x => x.name),
                    datasets: [
                        { label: 'Actual', data: activeCats.map(x => x.actual), backgroundColor: pastelColors[0], barPercentage: 0.5 },
                        { label: 'Budget', data: activeCats.map(x => x.budget), backgroundColor: '#E9ECEF', borderColor: '#CCC', borderWidth: 1, barPercentage: 0.5 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false,
                    onClick: (e, el) => { if(el.length) filterByHealthList(activeCats[el[0].index].name); }
                }
            });
        }

        function renderHealthList(mObj) {
            const container = document.getElementById('healthListContainer');
            const unusedContainer = document.getElementById('unusedListContainer');
            container.innerHTML = ''; unusedContainer.innerHTML = '';

            let totalB = 0, over = 0, under = 0, unusedCount = 0;

            categories.forEach(cat => {
                const actual = transactions.filter(t => t.CategoryName === cat.Name && new Date(t.Date).getMonth()+1 === mObj.month && new Date(t.Date).getFullYear() === mObj.year).reduce((s,t) => s + t.Amount, 0);
                const budget = getEffectiveBudget(cat.Id, mObj.month, mObj.year);

                if(actual === 0 && budget === 0) {
                    unusedCount++;
                    unusedContainer.innerHTML += `<div class="p-2 border-bottom small text-muted d-flex justify-content-between align-items-center">${cat.Name} <button class="btn btn-link btn-xs p-0" onclick="openBudgetModal(${cat.Id}, 0, true)">Add</button></div>`;
                    return;
                }

                totalB += budget;
                actual > budget ? over++ : under++;
                const pct = budget > 0 ? (actual/budget)*100 : 100;
                const color = actual > budget ? 'bg-danger' : (pct > 85 ? 'bg-warning' : 'bg-success');

                container.innerHTML += `
                <div class="p-3 border-bottom cursor-pointer hover-bg-light" onclick="filterByHealthList('${cat.Name}')">
                    <div class="d-flex justify-content-between small fw-bold">
                        <span class="${state.selectedCategory === cat.Name ? 'text-primary' : ''}">${cat.Name}</span>
                        <span>$${actual.toLocaleString()} (${Math.round(pct)}%)</span>
                    </div>
                    <div class="progress my-1" style="height:6px;"><div class="progress-bar ${color}" style="width:${Math.min(pct, 100)}%"></div></div>
                    <div class="d-flex justify-content-between extra-small text-muted">
                        <span>Limit: $${budget.toLocaleString()}</span>
                        <i class="bi bi-pencil-square text-primary" onclick="event.stopPropagation(); openBudgetModal(${cat.Id}, ${budget}, false)"></i>
                    </div>
                </div>`;
            });

            document.getElementById('unusedCount').innerText = unusedCount;
            document.getElementById('monthTotalBudgetLabel').innerText = `$${totalB.toLocaleString()}`;
            document.getElementById('overspentDetails').innerText = `${over} Overspent`;
            document.getElementById('savingsDetails').innerText = `${under} Within Limits`;
        }

        // 1. Restore Action Functions
        async function autoReallocate() {
            if(!confirm("Reallocate unused funds to cover the worst deficit for this month?")) return;
            const res = await fetch(`/Budget/AutoReallocate?month=${state.currentMonthObj.month}&year=${state.currentMonthObj.year}`, { method: 'POST' });
            const json = await res.json();
            alert(json.message); if(json.success) location.reload();
        }

        async function smartIncrease() {
            if(!confirm("Automatically increase all overspent categories to the nearest $1,000?")) return;
            const res = await fetch(`/Budget/SmartIncreaseAll?month=${state.currentMonthObj.month}&year=${state.currentMonthObj.year}`, { method: 'POST' });
            const json = await res.json();
            alert(json.message); if(json.success) location.reload();
        }

        // 2. Updated Modal Handler (Handles Add vs Edit states)
        function openBudgetModal(catId, currentAmount, isAdd = false) {
            const mObj = state.currentMonthObj;
            const sel = document.getElementById('modalCatId');

            sel.value = catId || "";
            sel.disabled = !isAdd; // Lock category if editing
            document.getElementById('modalSearchContainer').style.display = isAdd ? "" : "none";

            document.getElementById('modalAmount').value = currentAmount;
            document.getElementById('modalMonth').value = mObj.month;
            document.getElementById('modalYear').value = mObj.year;

            document.getElementById('modalTitle').innerText = isAdd ? "Set New Budget" : "Update Limit";

            new bootstrap.Modal(document.getElementById('editBudgetModal')).show();
        }

        // 3. Search logic for modal
        function filterModalSelect() {
            const val = document.getElementById('modalSearch').value.toLowerCase();
            const opts = document.getElementById('modalCatId').options;
            for(let o of opts) {
                o.style.display = o.text.toLowerCase().includes(val) ? "" : "none";
            }
        }

        // 4. Table Sorting Logic
        function sortTable(col) {
            state.sortDir = (state.sortCol === col) ? state.sortDir * -1 : 1;
            state.sortCol = col;
            filterAndRenderTable();
        }

        // Update your existing filterAndRenderTable to support the sort
        function filterAndRenderTable() {
            const m = state.currentMonthObj;
            let data = transactions.filter(t =>
                new Date(t.Date).getMonth()+1 === m.month &&
                new Date(t.Date).getFullYear() === m.year
            );

            if(state.selectedCategory) {
                data = data.filter(t => t.CategoryName === state.selectedCategory);
            }

            state.tableData = data.sort((a,b) => {
                let vA = a[state.sortCol], vB = b[state.sortCol];
                if(state.sortCol === 'Date') { vA = new Date(vA); vB = new Date(vB); }
                return (vA < vB ? -1 : 1) * state.sortDir;
            });

            state.currentPage = 1;
            renderTablePage();
        }

        function renderTablePage() {
            const start = (state.currentPage - 1) * state.pageSize;
            const end = Math.min(start + state.pageSize, state.tableData.length);
            document.getElementById('budgetLedgerBody').innerHTML = state.tableData.slice(start, end).map(t => `
                <tr><td>${t.Date}</td><td>${t.Description}</td><td>${t.CategoryName}</td><td class="text-end fw-bold">$${t.Amount.toLocaleString()}</td></tr>
            `).join('') || '<tr><td colspan="4" class="text-center p-4">No data</td></tr>';
            document.getElementById('pageInfoLabel').innerText = `Showing ${state.tableData.length > 0 ? start+1 : 0}-${end} of ${state.tableData.length}`;
        }

        // Helper: Toggle Search in Modal
        function filterModalSelect() {
            const val = document.getElementById('modalSearch').value.toLowerCase();
            const opts = document.getElementById('modalCatId').options;
            for(let o of opts) o.style.display = o.text.toLowerCase().includes(val) ? "" : "none";
        }

        

        // Core Functions
        function backToTrend() { renderTrendChart(); }
        function updateRange(r) { state.activeRange = r; renderTrendChart(); }
        function enterMonthView(mObj) { state.currentMonthObj = mObj; if(state.isBreakdown) renderBreakdownChart(mObj); renderHealthList(mObj); filterAndRenderTable(); }
        function filterByHealthList(n) { state.selectedCategory = (state.selectedCategory === n) ? null : n; filterAndRenderTable(); }
        function clearTableFilters() { state.selectedCategory = null; filterAndRenderTable(); }
        function changePage(dir) { if(state.currentPage + dir > 0) { state.currentPage += dir; renderTablePage(); } }
        function changePageSize() { state.pageSize = parseInt(document.getElementById('pageSizeSelect').value); renderTablePage(); }
        function getMonthRange() {
            const range = [];
            for (let i = state.activeRange - 1; i >= 0; i--) {
                const d = new Date(latestDate.getFullYear(), latestDate.getMonth() - i, 1);
                range.push({ month: d.getMonth() + 1, year: d.getFullYear(), label: d.toLocaleString('default', { month: 'short', year: '2-digit' }) });
            }
            return range;
        }

        async function saveBudgetChange() {
            const payload = {
                categoryId: document.getElementById('modalCatId').value,
                amount: document.getElementById('modalAmount').value,
                month: document.getElementById('modalMonth').value,
                year: document.getElementById('modalYear').value
            };
            const res = await fetch('/Budget/UpdateBudget', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: new URLSearchParams(payload)});
            const result = await res.json();
            if (result.success) location.reload(); else alert("Error: " + result.error);
        }
    </script>
}