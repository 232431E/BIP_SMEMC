@model BIP_SMEMC.Models.ViewModels.CommunityHubViewModel

@{
    ViewData["Title"] = "Community";
    var profile = Model.Profile ?? new BIP_SMEMC.Models.CommunityProfile();
    var discussionCount = profile.DiscussionsCount;
    var eventCount = Model.Events?.Count(e => e.IsRegistered) ?? profile.EventsRsvpedCount;
    var resourceCount = profile.ResourcesDownloadedCount;
    var badgeCount = profile.BadgesEarnedCount;
    var activeTab = (ViewData["ActiveTab"] as string ?? "discussions").ToLowerInvariant();
    var rewardPoints = (ViewData["RewardPoints"] as int?) ?? profile.ReputationPoints;
    var discussionsActive = activeTab == "discussions";
    var eventsActive = activeTab == "events";
    var resourcesActive = activeTab == "resources";
    var badgesActive = activeTab == "badges";

    string GetProgressTrack(BIP_SMEMC.Models.CommunityBadge badge)
    {
        var text = $"{badge.Title} {badge.Description}".ToLowerInvariant();
        if (text.Contains("module")) return "learning-modules";
        if (text.Contains("quiz")) return "learning-quiz";
        if (text.Contains("thread") || text.Contains("discussion")) return "community-discussions";
        if (text.Contains("reply")) return "community-replies";
        if (text.Contains("event") || text.Contains("rsvp")) return "community-events";
        if (text.Contains("resource") || text.Contains("download")) return "community-resources";
        if (text.Contains("point") || text.Contains("reputation")) return "points";
        return "general";
    }

    var visibleProgressBadges = (Model.BadgesInProgress ?? new List<BIP_SMEMC.Models.CommunityBadge>())
        .OrderBy(b => b.ProgressTarget ?? int.MaxValue)
        .ThenBy(b => b.ProgressCurrent ?? 0)
        .ThenBy(b => b.Points)
        .ThenBy(b => b.Id)
        .GroupBy(GetProgressTrack)
        .Select(g => g.First())
        .ToList();
}

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h2 class="fw-bold mb-1">SME Community &amp; Support Network</h2>
            <div class="text-muted">Connect, learn, and grow with fellow entrepreneurs</div>
        </div>

        <a asp-controller="Rewards" asp-action="Index" class="text-decoration-none text-reset d-block">
            <div class="card shadow-sm community-reputation">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div class="me-3">
                        <div class="text-muted small">Total Points</div>
                        <div class="fs-3 fw-bold">@rewardPoints</div>
                        <div class="text-muted small">Expires: @DateTime.Now.AddYears(2).ToShortDateString()</div>
                    </div>
                    <div class="fs-1 text-warning">
                        <i class="bi bi-trophy"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm h-100 community-card" data-tab="discussions">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-chat-left-text"></i>
                    <div class="fw-semibold">My Discussions</div>
                </div>
                <div class="fs-3 fw-bold">@discussionCount</div>
                <div class="text-muted small">Participated in</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm h-100 community-card" data-tab="events">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-calendar-event"></i>
                    <div class="fw-semibold">My Events</div>
                </div>
                <div class="fs-3 fw-bold">@eventCount</div>
                <div class="text-muted small">RSVPed to</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm h-100 community-card" data-tab="resources">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-download"></i>
                    <div class="fw-semibold">My Resources</div>
                </div>
                <div class="fs-3 fw-bold" id="myResourcesCount">@resourceCount</div>
                <div class="text-muted small">Downloaded</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm h-100 community-card" data-tab="badges">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-award"></i>
                    <div class="fw-semibold">My Badges</div>
                </div>
                <div class="fs-3 fw-bold" id="myBadgesCount">@badgeCount</div>
                <div class="text-muted small">Earned badges</div>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-pills gap-2 mb-4 community-tabs" id="communityTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link @(discussionsActive ? "active" : "")" id="tab-discussions" data-bs-toggle="pill" data-bs-target="#panel-discussions" type="button" role="tab">
            <i class="bi bi-chat-left-text me-1"></i> Discussions
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(eventsActive ? "active" : "")" id="tab-events" data-bs-toggle="pill" data-bs-target="#panel-events" type="button" role="tab">
            <i class="bi bi-calendar-event me-1"></i> Events
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(resourcesActive ? "active" : "")" id="tab-resources" data-bs-toggle="pill" data-bs-target="#panel-resources" type="button" role="tab">
            <i class="bi bi-download me-1"></i> Resources
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(badgesActive ? "active" : "")" id="tab-badges" data-bs-toggle="pill" data-bs-target="#panel-badges" type="button" role="tab">
            <i class="bi bi-award me-1"></i> Badges
        </button>
    </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade @(discussionsActive ? "show active" : "")" id="panel-discussions" role="tabpanel">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
            <div class="input-group" style="max-width: 520px;">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text"
                       id="searchBox"
                       class="form-control"
                       placeholder="Search discussions..."
                       autocomplete="off" />
            </div>
            <a href="/Community/Create" class="btn btn-dark">
                <i class="bi bi-plus-lg me-1"></i> New Discussion
            </a>
        </div>

        <div id="threadList">
            @await Html.PartialAsync("_ThreadList", Model.Threads)
        </div>
        <div id="threadPager" class="d-flex gap-2 justify-content-center mt-3"></div>
    </div>

    <div class="tab-pane fade @(eventsActive ? "show active" : "")" id="panel-events" role="tabpanel">
        <div class="community-section mb-3">
            <div>
                <h5 class="fw-semibold mb-1">Event &amp; Webinar Ticketing System</h5>
                <div class="text-muted">Register for upcoming events and track your attendance</div>
            </div>
        </div>

        <div class="row g-3" id="eventsList">
            @foreach (var ev in Model.Events)
            {
                var badgeClass = ev.IsRegistered ? "bg-success-subtle text-success" : "bg-light text-muted";
                var cardClass = ev.IsRegistered ? "community-event-card registered" : "community-event-card";

                <div class="col-lg-6 paginate-item">
                    <div class="card shadow-sm h-100 @cardClass">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge rounded-pill text-bg-light">@ev.EventType</span>
                                <span class="badge rounded-pill text-bg-light">@ev.Category</span>
                                @if (!string.IsNullOrWhiteSpace(ev.StatusLabel))
                                {
                                    <span class="badge rounded-pill @badgeClass">@ev.StatusLabel</span>
                                }
                                @if (ev.ReminderSet)
                                {
                                    <span class="badge rounded-pill text-bg-light">Reminder Set</span>
                                }
                            </div>

                            <h5 class="fw-semibold mb-1">@ev.Title</h5>
                            <div class="text-muted small mb-2">by @ev.HostName@if (!string.IsNullOrWhiteSpace(ev.HostTitle)){<span>, @ev.HostTitle</span>}</div>

                            <div class="d-flex flex-wrap gap-4 text-muted small mb-3">
                                <div><i class="bi bi-calendar-event me-1"></i>@ev.StartAt.ToString("MM/dd/yyyy h:mm tt") @ev.Timezone</div>
                                <div><i class="bi bi-geo-alt me-1"></i>@ev.Location</div>
                            </div>

                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div class="community-progress">
                                    <div class="progress">
                                        @{
                                            var pct = ev.SeatsTotal == 0 ? 0 : (int)Math.Round(ev.SeatsBooked * 100.0 / ev.SeatsTotal);
                                        }
                                    <div class="progress-bar event-progress" data-event-id="@ev.Id" role="progressbar" style="width: @pct%"></div>
                                    </div>
                                    <div class="text-muted small mt-1"><span class="event-seat-text" data-event-id="@ev.Id">@ev.SeatsBooked / @ev.SeatsTotal seats booked</span></div>
                                </div>
                                <div class="ms-auto">
                                    @if (ev.IsRegistered)
                                    {
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-dark btn-sm event-details-btn" data-event-id="@ev.Id">Details</button>
                                            <button class="btn btn-dark btn-sm event-cancel-btn" data-event-id="@ev.Id">Cancel RSVP</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-dark btn-sm event-rsvp-btn" data-event-id="@ev.Id">RSVP</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div id="eventsPager" class="d-flex gap-2 justify-content-center mt-3"></div>
    </div>

    <div class="tab-pane fade @(resourcesActive ? "show active" : "")" id="panel-resources" role="tabpanel">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
            <div>
                <h5 class="fw-semibold mb-1">Resource Sharing Library</h5>
                <div class="text-muted">Templates, guides, and tools shared by the community</div>
            </div>
            <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#uploadResourceModal">
                <i class="bi bi-upload me-1"></i> Upload Resource
            </button>
        </div>

        <div class="row g-3" id="resourcesList">
            @foreach (var res in Model.Resources)
            {
                var downloadedByUser = Model.DownloadedResourceIds.Contains(res.Id);
                <div class="col-lg-6 paginate-item">
                    <div class="card shadow-sm h-100 community-resource-card">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge rounded-pill text-bg-light">@res.TagPrimary</span>
                                <span class="badge rounded-pill text-bg-light">@res.TagSecondary</span>
                            </div>
                            <h6 class="fw-semibold mb-1">@res.Title</h6>
                            <div class="text-muted small mb-2">by @res.Author</div>
                            <div class="text-muted small mb-3">@res.Summary</div>
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-muted small">
                                    <i class="bi bi-download me-1"></i><span class="resource-download-count" data-resource-id="@res.Id">@res.DownloadCount</span> downloads
                                </div>
                                <a class="btn btn-dark btn-sm resource-download-btn"
                                   href="@Url.Action("DownloadResource", "Community", new { id = res.Id })"
                                   data-resource-id="@res.Id">
                                    <i class="bi bi-download me-1"></i>
                                    @(downloadedByUser ? "Download Again" : $"Download (+{res.PointsReward} pts)")
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div id="resourcesPager" class="d-flex gap-2 justify-content-center mt-3"></div>
    </div>

    <div class="tab-pane fade @(badgesActive ? "show active" : "")" id="panel-badges" role="tabpanel">
        <div class="community-section mb-3">
            <div class="d-flex align-items-start gap-2">
                <i class="bi bi-trophy text-warning fs-5"></i>
                <div>
                    <h5 class="fw-semibold mb-1">Your Achievements</h5>
                    <div class="text-muted">Badges you've earned so far</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4" id="earnedBadgesList">
            @foreach (var badge in Model.BadgesEarned)
            {
                <div class="col-lg-6 paginate-item" data-earned-badge-title="@badge.Title">
                    <div class="card shadow-sm h-100 badge-earned">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-3">
                                <div class="badge-icon @badge.IconColor">
                                    <i class="bi @badge.Icon"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">@badge.Title <span class="badge text-bg-success ms-1">Earned</span></div>
                                    <div class="text-muted small">@badge.Description</div>
                                    @if (badge.EarnedAt.HasValue)
                                    {
                                        <div class="text-muted small mt-1">Earned on @badge.EarnedAt.Value.ToString("yyyy-MM-dd")</div>
                                    }
                                </div>
                            </div>
                            <span class="badge text-bg-warning">+@badge.Points pts</span>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div id="earnedBadgesPager" class="d-flex gap-2 justify-content-center mb-4"></div>

        <div class="community-section mb-3">
            <div class="d-flex align-items-start gap-2">
                <i class="bi bi-stars text-primary fs-5"></i>
                <div>
                    <h5 class="fw-semibold mb-1">Badges In Progress</h5>
                    <div class="text-muted">Keep going! Complete these milestones to earn rewards</div>
                </div>
            </div>
        </div>

        <div class="row g-3" id="progressBadgesList">
            @foreach (var badge in visibleProgressBadges)
            {
                <div class="col-12 paginate-item" data-progress-badge-title="@badge.Title">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="fw-semibold d-flex align-items-center gap-2">
                                    <i class="bi @badge.Icon @badge.IconColor"></i>
                                    <span>@badge.Title</span>
                                </div>
                                <span class="badge text-bg-primary">+@badge.Points pts</span>
                            </div>
                            <div class="text-muted small mb-3">@badge.Description</div>
                            <div class="progress community-progress-bar">
                                <div class="progress-bar" role="progressbar" data-progress-bar="@badge.Title" style="width: @(badge.ProgressPercent ?? 0)%"></div>
                            </div>
                            <div class="d-flex justify-content-between text-muted small mt-2">
                                <span data-progress-text="@badge.Title">@(badge.ProgressPercent ?? 0)% complete</span>
                                <span data-progress-ratio="@badge.Title">@(badge.ProgressCurrent ?? 0) / @(badge.ProgressTarget ?? 0)</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div id="progressBadgesPager" class="d-flex gap-2 justify-content-center mt-3"></div>
    </div>
</div>

<div class="modal fade" id="rsvpConfirmModal" tabindex="-1" aria-labelledby="rsvpConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="rsvpConfirmLabel">RSVP Confirmed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="text-center mb-3">
                    <i class="bi bi-check-circle-fill text-success fs-1"></i>
                    <div class="text-muted small mt-2">Your seat has been reserved.</div>
                </div>

                <div class="card bg-light border-0 mb-3">
                    <div class="card-body">
                        <div class="fw-semibold mb-2" id="rsvpEventTitle">-</div>
                        <div class="small text-muted mb-1"><i class="bi bi-calendar-event me-2"></i><span id="rsvpEventDateTime">-</span></div>
                        <div class="small text-muted mb-1"><i class="bi bi-geo-alt me-2"></i><span id="rsvpEventLocation">-</span></div>
                        <div class="small text-muted"><i class="bi bi-person me-2"></i><span id="rsvpEventSpeaker">-</span></div>
                    </div>
                </div>

                <div class="alert alert-primary py-2 mb-0">
                    Reminder is set. You will receive a notification before the event starts.
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Got it</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadResourceModal" tabindex="-1" aria-labelledby="uploadResourceLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="/Community/UploadResource" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadResourceLabel">Upload Resource</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Title</label>
                            <input class="form-control" name="title" required maxlength="120" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Summary</label>
                            <textarea class="form-control" name="summary" rows="3" required maxlength="300"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Primary Tag</label>
                            <input class="form-control" name="tagPrimary" placeholder="Templates" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Secondary Tag</label>
                            <input class="form-control" name="tagSecondary" placeholder="PDF / XLSX" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">File</label>
                            <input class="form-control" type="file" name="file" required />
                            <div class="form-text">Uploads to Supabase Storage (public)</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="antiForgeryForm" method="post">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        const antiForgeryToken = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value;
        const searchBox = document.getElementById("searchBox");
        const threadList = document.getElementById("threadList");
        let timeout = null;

        (function ensureRequestedTabIsActive() {
            const params = new URLSearchParams(window.location.search);
            const tab = (params.get("tab") || "").toLowerCase();
            if (!tab) return;
            const btn = document.getElementById(`tab-${tab}`);
            if (!btn) return;
            const bsTab = new bootstrap.Tab(btn);
            bsTab.show();
        })();

        const pagerState = new Map();

        function paginate(containerSelector, itemSelector, pagerSelector, pageSize) {
            const container = document.querySelector(containerSelector);
            const pager = document.querySelector(pagerSelector);
            if (!container || !pager) return;

            const directItems = Array.from(container.children).filter(el => el.matches(itemSelector));
            const items = directItems.length > 0
                ? directItems
                : Array.from(container.querySelectorAll(itemSelector));
            if (items.length === 0) {
                pager.innerHTML = "";
                return;
            }

            const pages = Math.ceil(items.length / pageSize);
            let current = pagerState.get(pagerSelector) || 1;
            if (current > pages) current = 1;

            const render = () => {
                items.forEach((el, i) => {
                    const show = i >= (current - 1) * pageSize && i < current * pageSize;
                    el.style.display = show ? "" : "none";
                    el.classList.toggle("d-none", !show);
                    el.setAttribute("aria-hidden", show ? "false" : "true");
                });

                if (pages <= 1) {
                    pager.innerHTML = "";
                    return;
                }

                pager.innerHTML = "";
                for (let p = 1; p <= pages; p++) {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = `btn btn-sm ${p === current ? "btn-dark" : "btn-outline-secondary"}`;
                    btn.textContent = p;
                    btn.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        current = p;
                        pagerState.set(pagerSelector, current);
                        render();
                        container.scrollIntoView({ behavior: "smooth", block: "start" });
                    });
                    pager.appendChild(btn);
                }
            };

            render();
        }

        function applyCommunityPagination() {
            paginate("#threadList", ".paginate-item", "#threadPager", 6);
            paginate("#eventsList", ".paginate-item", "#eventsPager", 6);
            paginate("#resourcesList", ".paginate-item", "#resourcesPager", 6);
            paginate("#earnedBadgesList", ".paginate-item", "#earnedBadgesPager", 6);
            paginate("#progressBadgesList", ".paginate-item", "#progressBadgesPager", 5);
        }

        if (searchBox) {
            searchBox.addEventListener("input", () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    const query = searchBox.value;
                    fetch(`/Community/Search?q=${encodeURIComponent(query)}`)
                        .then(res => res.text())
                        .then(html => {
                            threadList.innerHTML = html;
                            paginate("#threadList", ".paginate-item", "#threadPager", 6);
                        });
                }, 250);
            });
        }

        applyCommunityPagination();

        document.querySelectorAll(".community-card").forEach(card => {
            card.addEventListener("click", () => {
                const target = card.getAttribute("data-tab");
                const btn = document.getElementById(`tab-${target}`);
                if (!btn) return;
                const tab = new bootstrap.Tab(btn);
                tab.show();
            });
        });

        document.addEventListener("click", (event) => {
            const btn = event.target.closest(".upvote-btn");
            if (!btn) return;

            event.preventDefault();
            event.stopPropagation();

            const threadId = btn.getAttribute("data-thread-id");
            if (!threadId) return;

            fetch(`/Community/Upvote/${threadId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": antiForgeryToken || ""
                }
            })
                .then(res => res.json())
                .then(data => {
                    const countEl = document.querySelector(`.upvote-count[data-thread-id="${threadId}"]`);
                    if (countEl && typeof data?.upvotes === "number") {
                        countEl.textContent = data.upvotes;
                    }
                });
        });

        const rsvpModalEl = document.getElementById("rsvpConfirmModal");
        const rsvpModal = rsvpModalEl ? new bootstrap.Modal(rsvpModalEl) : null;

        function updateEventCardToRegistered(eventId) {
            const actionsHost = document.querySelector(`.event-rsvp-btn[data-event-id="${eventId}"]`)?.parentElement;
            if (!actionsHost) return;
            actionsHost.innerHTML = `
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-dark btn-sm event-details-btn" data-event-id="${eventId}">Details</button>
                    <button class="btn btn-dark btn-sm event-cancel-btn" data-event-id="${eventId}">Cancel RSVP</button>
                </div>
            `;
        }

        function updateEventCardToNotRegistered(eventId) {
            const detailsBtn = document.querySelector(`.event-details-btn[data-event-id="${eventId}"]`);
            const actionsHost = detailsBtn?.closest(".ms-auto");
            if (!actionsHost) return;
            actionsHost.innerHTML = `<button class="btn btn-dark btn-sm event-rsvp-btn" data-event-id="${eventId}">RSVP</button>`;
        }

        function updateSeats(eventId, seatsBooked, seatsTotal) {
            const seatText = document.querySelector(`.event-seat-text[data-event-id="${eventId}"]`);
            if (seatText) {
                seatText.textContent = `${seatsBooked} / ${seatsTotal} seats booked`;
            }

            const progress = document.querySelector(`.event-progress[data-event-id="${eventId}"]`);
            if (progress) {
                const pct = seatsTotal > 0 ? Math.round((seatsBooked * 100) / seatsTotal) : 0;
                progress.style.width = `${pct}%`;
            }
        }

        function updateMyEventsCount(newCount) {
            const countEl = document.querySelector('.community-card[data-tab="events"] .fs-3');
            if (countEl && typeof newCount === "number") {
                countEl.textContent = newCount;
            }
        }

        function escapeAttrValue(value) {
            if (window.CSS && typeof window.CSS.escape === "function") {
                return window.CSS.escape(value ?? "");
            }
            return (value ?? "").replace(/["\\]/g, "\\$&");
        }

        async function refreshBadgeSnapshot() {
            try {
                const res = await fetch("/Community/BadgeSnapshot", { method: "GET" });
                if (!res.ok) return;
                const data = await res.json();

                const badgeCountEl = document.getElementById("myBadgesCount");
                if (badgeCountEl && typeof data.badgeCount === "number") {
                    badgeCountEl.textContent = data.badgeCount;
                }

                if (!Array.isArray(data.progress)) return;

                data.progress.forEach((badge) => {
                    const key = escapeAttrValue(badge.title || "");
                    const bar = document.querySelector(`[data-progress-bar="${key}"]`);
                    const text = document.querySelector(`[data-progress-text="${key}"]`);
                    const ratio = document.querySelector(`[data-progress-ratio="${key}"]`);

                    if (bar && typeof badge.percent === "number") {
                        bar.style.width = `${badge.percent}%`;
                    }
                    if (text && typeof badge.percent === "number") {
                        text.textContent = `${badge.percent}% complete`;
                    }
                    if (ratio) {
                        ratio.textContent = `${badge.current ?? 0} / ${badge.target ?? 0}`;
                    }
                });
            } catch {
                // no-op: UI refresh should not break RSVP/download flows
            }
        }

        function fillRsvpModal(data) {
            const titleEl = document.getElementById("rsvpEventTitle");
            const dateTimeEl = document.getElementById("rsvpEventDateTime");
            const locationEl = document.getElementById("rsvpEventLocation");
            const speakerEl = document.getElementById("rsvpEventSpeaker");
            if (titleEl) titleEl.textContent = data.title || "-";
            if (dateTimeEl) dateTimeEl.textContent = `${data.date || ""} ${data.time || ""} ${data.timezone || ""}`.trim();
            if (locationEl) locationEl.textContent = data.location || "-";
            if (speakerEl) {
                const host = [data.hostName, data.hostTitle].filter(Boolean).join(", ");
                speakerEl.textContent = host || "-";
            }
        }

        document.addEventListener("click", (event) => {
            const rsvpBtn = event.target.closest(".event-rsvp-btn");
            if (!rsvpBtn) return;
            event.preventDefault();

            const eventId = rsvpBtn.getAttribute("data-event-id");
            if (!eventId) return;

            fetch(`/Community/RsvpEvent/${eventId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": antiForgeryToken || ""
                }
            })
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    updateEventCardToRegistered(eventId);
                    updateSeats(eventId, data.seatsBooked, data.seatsTotal);
                    updateMyEventsCount(data.registeredCount);
                    fillRsvpModal(data);
                    refreshBadgeSnapshot();
                    rsvpModal?.show();
                });
        });

        document.addEventListener("click", (event) => {
            const detailsBtn = event.target.closest(".event-details-btn");
            if (!detailsBtn) return;
            event.preventDefault();

            const eventCard = detailsBtn.closest(".card-body");
            if (!eventCard) return;

            const title = eventCard.querySelector("h5")?.textContent?.trim() || "-";
            const host = eventCard.querySelector(".text-muted.small.mb-2")?.textContent?.replace(/^by\s+/i, "").trim() || "-";
            const dateTime = eventCard.querySelector(".d-flex.flex-wrap.gap-4 .bi-calendar-event")?.parentElement?.textContent?.trim() || "-";
            const location = eventCard.querySelector(".d-flex.flex-wrap.gap-4 .bi-geo-alt")?.parentElement?.textContent?.trim() || "-";

            fillRsvpModal({
                title,
                date: dateTime,
                time: "",
                timezone: "",
                location,
                hostName: host,
                hostTitle: ""
            });
            rsvpModal?.show();
        });

        document.addEventListener("click", (event) => {
            const cancelBtn = event.target.closest(".event-cancel-btn");
            if (!cancelBtn) return;
            event.preventDefault();

            const eventId = cancelBtn.getAttribute("data-event-id");
            if (!eventId) return;

            fetch(`/Community/CancelEventRsvp/${eventId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": antiForgeryToken || ""
                }
            })
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    updateEventCardToNotRegistered(eventId);
                    updateSeats(eventId, data.seatsBooked, data.seatsTotal);
                    updateMyEventsCount(data.registeredCount);
                    refreshBadgeSnapshot();
                });
        });

        document.addEventListener("click", async (event) => {
            const downloadBtn = event.target.closest(".resource-download-btn");
            if (!downloadBtn) return;
            event.preventDefault();

            const resourceId = downloadBtn.getAttribute("data-resource-id");
            if (!resourceId) return;

            const iconHtml = '<i class="bi bi-download me-1"></i>';
            downloadBtn.classList.add("disabled");
            downloadBtn.innerHTML = `${iconHtml}Downloading...`;

            try {
                const res = await fetch(`/Community/DownloadResource/${resourceId}?ajax=true`);
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    downloadBtn.classList.remove("disabled");
                    downloadBtn.innerHTML = `${iconHtml}Download`;
                    return;
                }

                const countEl = document.querySelector(`.resource-download-count[data-resource-id="${resourceId}"]`);
                if (countEl && typeof data.downloadCount === "number") {
                    countEl.textContent = data.downloadCount;
                }

                const myResourcesEl = document.getElementById("myResourcesCount");
                if (myResourcesEl && typeof data.userDownloadCount === "number") {
                    myResourcesEl.textContent = data.userDownloadCount;
                }

                refreshBadgeSnapshot();

                downloadBtn.classList.remove("disabled");
                downloadBtn.innerHTML = `${iconHtml}Download Again`;

                if (data.downloadUrl) {
                    const fileRes = await fetch(data.downloadUrl, { method: "GET" });
                    if (!fileRes.ok) {
                        return;
                    }

                    const blob = await fileRes.blob();
                    const objectUrl = window.URL.createObjectURL(blob);
                    const tempLink = document.createElement("a");
                    tempLink.href = objectUrl;

                    const disposition = fileRes.headers.get("content-disposition") || "";
                    const match = disposition.match(/filename\*?=(?:UTF-8'')?\"?([^\";]+)\"?/i);
                    if (match && match[1]) {
                        tempLink.download = decodeURIComponent(match[1]);
                    }

                    document.body.appendChild(tempLink);
                    tempLink.click();
                    tempLink.remove();
                    window.URL.revokeObjectURL(objectUrl);
                }
            } catch {
                downloadBtn.classList.remove("disabled");
                downloadBtn.innerHTML = `${iconHtml}Download`;
            }
        });
    </script>
}


